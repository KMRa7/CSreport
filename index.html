<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè‡ªå‹•æ•´å½¢ï¼†ã‚³ãƒ”ãƒ¼ï¼‰</title>
  <style>
    :root {
      --bg-gradient-start: #eef2ff;
      --bg-gradient-end: #fdf2ff;
      --card-bg: #ffffff;
      --accent: #4f46e5;
      --accent-soft: #e0e7ff;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 32px 16px 40px;
      background: radial-gradient(circle at top left, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 4px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ */
    .tab-bar-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 18px;
    }

    .tab-bar {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(12px);
    }

    .tab-bar button {
      appearance: none;
      border: none;
      background: transparent;
      font-size: 13px;
      padding: 8px 18px;
      border-radius: 999px;
      cursor: pointer;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }

    .tab-bar button span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--border-soft);
    }

    .tab-bar button:hover {
      background: #f9fafb;
      transform: translateY(-1px);
    }

    .tab-bar button.active {
      background: var(--accent);
      color: #ffffff;
    }

    .tab-bar button.active span.dot {
      background: #a5b4fc;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .container {
      margin-top: 8px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.18);
      display: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    .card.is-active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-header h2 {
      font-size: 18px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: #4b5563;
      background: #f9fafb;
    }

    .card-header .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* å…¥åŠ›ç³» */
    .field-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    label {
      font-size: 13px;
      white-space: nowrap;
      color: #374151;
      min-width: 52px;
    }

    input[type="text"] {
      flex: 1;
      padding: 7px 9px;
      font-size: 13px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.3);
    }

    .section-title {
      margin-top: 14px;
      font-weight: 600;
      font-size: 13px;
      border-left: 3px solid var(--accent);
      padding-left: 8px;
      color: #111827;
    }

    .section-title span.small {
      display: block;
      font-weight: normal;
      margin-top: 2px;
    }

    .sub-label {
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .inline-3 {
      display: grid;
      grid-template-columns: 22px 1fr;
      column-gap: 6px;
      row-gap: 4px;
      align-items: center;
      margin-bottom: 4px;
    }

    .inline-3 span.prefix {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    .small {
      font-size: 11px;
      color: var(--text-muted);
    }

    textarea.output {
      width: 100%;
      box-sizing: border-box;
      min-height: 260px;
      padding: 10px;
      margin-top: 8px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.9);
      background: #f9fafb;
      font-family: "Meiryo", system-ui, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      color: #111827;
    }

    textarea.output:focus {
      outline: none;
      border-style: solid;
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
    }

    /* ãƒœã‚¿ãƒ³ */
    .actions {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-primary {
      appearance: none;
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color: #ffffff;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 16px 35px rgba(79, 70, 229, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.32);
    }

    .btn-primary .emoji {
      font-size: 14px;
    }

    .btn-secondary {
      appearance: none;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 5px 14px;
      font-size: 12px;
      cursor: pointer;
      background: #ffffff;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      transition: background 0.15s ease, color 0.15s ease,
                  box-shadow 0.15s ease, transform 0.08s ease;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      color: #374151;
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(148, 163, 184, 0.4);
    }

    .btn-secondary:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(148, 163, 184, 0.3);
    }

    .msg {
      font-size: 12px;
      color: var(--accent);
    }

    hr {
      margin: 16px 0 10px;
      border: none;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
    }

    @media (max-width: 640px) {
      .card {
        padding: 18px 14px;
      }
      .tab-bar {
        width: 100%;
        justify-content: space-between;
      }
      .tab-bar button {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </h1>
    <div class="subtitle">ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ› â†’ ã€Œç”Ÿæˆã—ã¦ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆï¼†ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</div>

    <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
    <div class="tab-bar-wrapper">
      <div class="tab-bar">
        <button type="button" id="btn-front" onclick="showForm('front')">
          <span class="dot"></span>
          <span>ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰</span>
        </button>
        <button type="button" id="btn-back" onclick="showForm('back')">
          <span class="dot"></span>
          <span>ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ï¼‰</span>
        </button>
      </div>
    </div>

    <div class="container">
      <!-- ãƒ•ãƒ­ãƒ³ãƒˆç”¨ -->
      <div class="card" id="front-card">
        <div class="card-header">
          <h2>
            ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆç”¨ï¼‰
            <span class="badge">Front</span>
          </h2>
          <span class="hint">ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™ã®æ—¥å ±ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</span>
        </div>

        <div class="field-row">
          <label for="front-date">æ—¥ä»˜ï¼š</label>
          <input type="text" id="front-date" placeholder="ä¾‹ï¼‰2025/11/20">
        </div>
        <div class="field-row">
          <label for="front-name">æ°åï¼š</label>
          <input type="text" id="front-name" placeholder="æ°åã‚’å…¥åŠ›">
        </div>

        <div class="section-title">
          â–  æœ¬æ—¥ã®æˆæœãƒ»é€²æ—
          <span class="small">ï¼ˆæ›´æ–°ãƒ»MTGè¨­å®šãªã©è‡ªåˆ†ãªã‚Šã®æˆæœï¼‰</span>
        </div>
        <div class="inline-3" id="front-result-block">
          <span class="prefix">ãƒ»</span><input type="text" id="front-result1" class="front-result-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-result2" class="front-result-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-result3" class="front-result-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addFrontResult()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">
          â–  èª²é¡Œãƒ»å•é¡Œç‚¹
          <span class="small">ï¼ˆå€‹äººã®èª²é¡Œãƒ»å•é¡Œç‚¹ï¼‰</span>
        </div>
        <div class="inline-3" id="front-issue-block">
          <span class="prefix">ãƒ»</span><input type="text" id="front-issue1" class="front-issue-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-issue2" class="front-issue-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-issue3" class="front-issue-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addFrontIssue()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">
          â–  æ˜æ—¥ã®äºˆå®š
          <span class="small">ï¼ˆMTG/MTGå¤–ã®å‹•ãï¼‰</span>
        </div>
        <div class="inline-3" id="front-plan-block">
          <span class="prefix">1.</span><input type="text" id="front-plan1" class="front-plan-input">
          <span class="prefix">2.</span><input type="text" id="front-plan2" class="front-plan-input">
          <span class="prefix">3.</span><input type="text" id="front-plan3" class="front-plan-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addFrontPlan()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">
          â–  æœ¬æ—¥ã®æ°—ã¥ããƒ»æŒ¯ã‚Šè¿”ã‚Š
          <span class="small">ï¼ˆå­¦ã³ãƒ»æ”¹å–„ç‚¹ãªã©ï¼‰</span>
        </div>
        <div class="inline-3" id="front-ref-block">
          <span class="prefix">ãƒ»</span><input type="text" id="front-ref1" class="front-ref-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-ref2" class="front-ref-input">
          <span class="prefix">ãƒ»</span><input type="text" id="front-ref3" class="front-ref-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addFrontRef()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <hr>

        <div class="small">â–¼ ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆè‡ªå‹•æ•´å½¢ï¼‰</div>
        <textarea id="front-output" class="output" readonly></textarea>
        <div class="actions">
          <button class="btn-primary" onclick="generateAndCopyFront()">
            <span class="emoji">ğŸ“</span>
            <span>ãƒ•ãƒ­ãƒ³ãƒˆç”¨ã‚’ç”Ÿæˆã—ã¦ã‚³ãƒ”ãƒ¼</span>
          </button>
          <span id="front-msg" class="msg"></span>
        </div>
      </div>

      <!-- ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ -->
      <div class="card" id="back-card">
        <div class="card-header">
          <h2>
            ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ï¼‰
            <span class="badge">Back / Office</span>
          </h2>
          <span class="hint">ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ãƒ»ãã®ä»–æ¥­å‹™ã®æ—¥å ±ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</span>
        </div>

        <div class="field-row">
          <label for="back-date">æ—¥ä»˜ï¼š</label>
          <input type="text" id="back-date" placeholder="ä¾‹ï¼‰2025/11/20">
        </div>
        <div class="field-row">
          <label for="back-name">æ°åï¼š</label>
          <input type="text" id="back-name" placeholder="æ°åã‚’å…¥åŠ›">
        </div>

        <div class="section-title">â–  æœ¬æ—¥ã®æ¥­å‹™å†…å®¹</div>
        <div class="inline-3" id="back-work-block">
          <span class="prefix">1.</span><input type="text" id="back-work1" class="back-work-input">
          <span class="prefix">2.</span><input type="text" id="back-work2" class="back-work-input">
          <span class="prefix">3.</span><input type="text" id="back-work3" class="back-work-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addBackWork()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">â–  æœ¬æ—¥ã®æˆæœãƒ»é€²æ—</div>
        <div class="inline-3" id="back-result-block">
          <span class="prefix">ãƒ»</span><input type="text" id="back-result1" class="back-result-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-result2" class="back-result-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-result3" class="back-result-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addBackResult()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">â–  èª²é¡Œãƒ»å•é¡Œç‚¹</div>
        <div class="inline-3" id="back-issue-block">
          <span class="prefix">ãƒ»</span><input type="text" id="back-issue1" class="back-issue-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-issue2" class="back-issue-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-issue3" class="back-issue-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addBackIssue()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">â–  æ˜æ—¥ã®äºˆå®š</div>
        <div class="inline-3" id="back-plan-block">
          <span class="prefix">1.</span><input type="text" id="back-plan1" class="back-plan-input">
          <span class="prefix">2.</span><input type="text" id="back-plan2" class="back-plan-input">
          <span class="prefix">3.</span><input type="text" id="back-plan3" class="back-plan-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addBackPlan()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <div class="section-title">â–  æ°—ã¥ããƒ»æŒ¯ã‚Šè¿”ã‚Šï¼ˆå­¦ã³ãƒ»æ”¹å–„ç‚¹ãªã©ï¼‰</div>
        <div class="inline-3" id="back-ref-block">
          <span class="prefix">ãƒ»</span><input type="text" id="back-ref1" class="back-ref-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-ref2" class="back-ref-input">
          <span class="prefix">ãƒ»</span><input type="text" id="back-ref3" class="back-ref-input">
        </div>
        <button type="button" class="btn-secondary" onclick="addBackRef()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

        <hr>

        <div class="small">â–¼ ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆè‡ªå‹•æ•´å½¢ï¼‰</div>
        <textarea id="back-output" class="output" readonly></textarea>
        <div class="actions">
          <button class="btn-primary" onclick="generateAndCopyBack()">
            <span class="emoji">ğŸ“‹</span>
            <span>ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ã‚’ç”Ÿæˆã—ã¦ã‚³ãƒ”ãƒ¼</span>
          </button>
          <span id="back-msg" class="msg"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
  // å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§ï¼ˆä¿å­˜ãƒ»å¾©å…ƒç”¨ï¼‰
  const FRONT_FIELDS = [
    "front-date","front-name",
    "front-result1","front-result2","front-result3",
    "front-issue1","front-issue2","front-issue3",
    "front-plan1","front-plan2","front-plan3",
    "front-ref1","front-ref2","front-ref3"
  ];

  const BACK_FIELDS = [
    "back-date","back-name",
    "back-work1","back-work2","back-work3",
    "back-result1","back-result2","back-result3",
    "back-issue1","back-issue2","back-issue3",
    "back-plan1","back-plan2","back-plan3",
    "back-ref1","back-ref2","back-ref3"
  ];

  // è‡ªå‹•ä¿å­˜å¯¾è±¡ï¼ˆâ€»æ—¥ä»˜ãƒ»åå‰ã¯é™¤å¤–ï¼‰
  const FRONT_SAVE_FIELDS = FRONT_FIELDS.filter(
    id => id !== "front-date" && id !== "front-name"
  );
  const BACK_SAVE_FIELDS = BACK_FIELDS.filter(
    id => id !== "back-date" && id !== "back-name"
  );

  // â–¼ ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
  function showForm(type) {
    const frontCard = document.getElementById("front-card");
    const backCard  = document.getElementById("back-card");
    const btnFront  = document.getElementById("btn-front");
    const btnBack   = document.getElementById("btn-back");

    if (type === "front") {
      frontCard.classList.add("is-active");
      backCard.classList.remove("is-active");
      btnFront.classList.add("active");
      btnBack.classList.remove("active");
    } else if (type === "back") {
      frontCard.classList.remove("is-active");
      backCard.classList.add("is-active");
      btnFront.classList.remove("active");
      btnBack.classList.add("active");
    }

    // â˜… æœ€å¾Œã«é–‹ã„ãŸã‚¿ãƒ–ã‚’ä¿å­˜
    try {
      localStorage.setItem("nippoLastTab", type);
    } catch (e) {
      console.error("ã‚¿ãƒ–çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  // å…±é€šï¼šå…¥åŠ›å€¤å–å¾—ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function v(id) {
    const el = document.getElementById(id);
    return el ? el.value.trim() : "";
  }

  // å…±é€šï¼šID ã¨ã‚¯ãƒ©ã‚¹ã§å€¤ã‚’é›†ã‚ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function gatherValues(ids, extraClass) {
    const values = [];

    if (Array.isArray(ids)) {
      ids.forEach(id => {
        const val = v(id);
        if (val) values.push(val);
      });
    }

    if (extraClass) {
      const inputs = document.querySelectorAll("input." + extraClass);
      inputs.forEach(input => {
        if (ids && ids.indexOf(input.id) !== -1) return; // ãƒ™ãƒ¼ã‚¹ã®3ä»¶ã¯é™¤å¤–
        const val = input.value.trim();
        if (val) values.push(val);
      });
    }
    return values;
  }

  // å…±é€šï¼šç®‡æ¡æ›¸ãï¼ˆãƒ»ï¼‰ã‚’çµ„ã¿ç«‹ã¦ï¼ˆï¼‹è¿½åŠ è¡Œå¯¾å¿œï¼‰
  function buildBullets(ids, extraClass) {
    const values = gatherValues(ids, extraClass);
    if (!values.length) return "ãƒ»";
    return values.map(t => "ãƒ»" + t).join("\n");
  }

  // å…±é€šï¼šç•ªå·ä»˜ã 1. 2. 3. ã‚’çµ„ã¿ç«‹ã¦ï¼ˆï¼‹è¿½åŠ è¡Œå¯¾å¿œï¼‰
  function buildNumbered(ids, extraClass) {
    const values = gatherValues(ids, extraClass);
    if (!values.length) return "1.\n\n2.\n\n3.";
    const lines = [];
    values.forEach((val, idx) => {
      lines.push((idx + 1) + ".");
      lines.push(val);
      lines.push("");
    });
    return lines.join("\n").replace(/\n$/, "");
  }

  // è¿½åŠ è¡Œã®å€¤ã ã‘ã‚’ä¿å­˜ç”¨ã«å–ã‚Šå‡ºã™
  function getExtraValues(extraClass, baseIds) {
    const values = [];
    const inputs = document.querySelectorAll("input." + extraClass);
    inputs.forEach(input => {
      if (baseIds && baseIds.indexOf(input.id) !== -1) return;
      const val = input.value.trim();
      if (val) values.push(val);
    });
    return values;
  }

  // å‹•çš„è¡Œã‚’å‰Šé™¤ï¼ˆãƒ™ãƒ¼ã‚¹ã® input ä»¥å¤–ã‚’å‰Šé™¤ï¼‰
  function clearDynamicRows(containerId, baseInputIds) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const inputs = Array.from(container.querySelectorAll("input"));
    inputs.forEach(input => {
      if (baseInputIds.indexOf(input.id) !== -1) return; // ãƒ™ãƒ¼ã‚¹è¡Œ
      const span = input.previousElementSibling;
      if (span && span.classList.contains("prefix")) {
        span.remove();
      }
      input.remove();
    });
  }

  function clearFrontDynamicSections() {
    clearDynamicRows("front-result-block", ["front-result1","front-result2","front-result3"]);
    clearDynamicRows("front-issue-block",  ["front-issue1","front-issue2","front-issue3"]);
    clearDynamicRows("front-plan-block",   ["front-plan1","front-plan2","front-plan3"]);
    clearDynamicRows("front-ref-block",    ["front-ref1","front-ref2","front-ref3"]);
  }

  function clearBackDynamicSections() {
    clearDynamicRows("back-work-block",   ["back-work1","back-work2","back-work3"]);
    clearDynamicRows("back-result-block", ["back-result1","back-result2","back-result3"]);
    clearDynamicRows("back-issue-block",  ["back-issue1","back-issue2","back-issue3"]);
    clearDynamicRows("back-plan-block",   ["back-plan1","back-plan2","back-plan3"]);
    clearDynamicRows("back-ref-block",    ["back-ref1","back-ref2","back-ref3"]);
  }

  // ===== ãƒ•ãƒ­ãƒ³ãƒˆï¼šè¡Œè¿½åŠ é–¢æ•° =====
  function addFrontResult(value = "") {
    const block = document.getElementById("front-result-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "front-result-input";
    input.value = value;
    input.addEventListener("change", saveFrontForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addFrontIssue(value = "") {
    const block = document.getElementById("front-issue-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "front-issue-input";
    input.value = value;
    input.addEventListener("change", saveFrontForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addFrontPlan(value = "") {
    const block = document.getElementById("front-plan-block");
    if (!block) return;
    const existing = block.querySelectorAll("input.front-plan-input");
    const num = existing.length + 1;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = num + ".";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "front-plan-input";
    input.value = value;
    input.addEventListener("change", saveFrontForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addFrontRef(value = "") {
    const block = document.getElementById("front-ref-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "front-ref-input";
    input.value = value;
    input.addEventListener("change", saveFrontForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  // ===== ãƒãƒƒã‚¯ï¼šè¡Œè¿½åŠ é–¢æ•° =====
  function addBackWork(value = "") {
    const block = document.getElementById("back-work-block");
    if (!block) return;
    const existing = block.querySelectorAll("input.back-work-input");
    const num = existing.length + 1;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = num + ".";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "back-work-input";
    input.value = value;
    input.addEventListener("change", saveBackForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addBackResult(value = "") {
    const block = document.getElementById("back-result-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "back-result-input";
    input.value = value;
    input.addEventListener("change", saveBackForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addBackIssue(value = "") {
    const block = document.getElementById("back-issue-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "back-issue-input";
    input.value = value;
    input.addEventListener("change", saveBackForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addBackPlan(value = "") {
    const block = document.getElementById("back-plan-block");
    if (!block) return;
    const existing = block.querySelectorAll("input.back-plan-input");
    const num = existing.length + 1;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = num + ".";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "back-plan-input";
    input.value = value;
    input.addEventListener("change", saveBackForm);
    block.appendChild(span);
    block.appendChild(input);
  }

  function addBackRef(value = "") {
    const block = document.getElementById("back-ref-block");
    if (!block) return;
    const span = document.createElement("span");
    span.className = "prefix";
    span.textContent = "ãƒ»";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "back-ref-input";
    input.value = value;
    input.addEventListener("change", saveBackForm);
    block.appendChild(span);
  }

  // ==== ãƒ•ãƒ­ãƒ³ãƒˆç”¨ ä¿å­˜ãƒ»å¾©å…ƒ ====  
  function getFrontKey() {
    const date = v("front-date");
    const name = v("front-name");
    if (!date || !name) return null;
    return `nippo_front_${date}_${name}`;
  }

  function clearFrontFormExceptKey() {
    FRONT_FIELDS.forEach(id => {
      if (id === "front-date" || id === "front-name") return;
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    clearFrontDynamicSections();
    const out = document.getElementById("front-output");
    if (out) out.value = "";
  }

  function saveFrontForm() {
    const key = getFrontKey();
    if (!key) return;

    const data = {};
    FRONT_FIELDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) data[id] = el.value;
    });

    // è¿½åŠ è¡Œï¼ˆ4ä»¶ç›®ä»¥é™ï¼‰
    data.extraFrontResults = getExtraValues("front-result-input", ["front-result1","front-result2","front-result3"]);
    data.extraFrontIssues  = getExtraValues("front-issue-input",  ["front-issue1","front-issue2","front-issue3"]);
    data.extraFrontPlans   = getExtraValues("front-plan-input",   ["front-plan1","front-plan2","front-plan3"]);
    data.extraFrontRefs    = getExtraValues("front-ref-input",    ["front-ref1","front-ref2","front-ref3"]);

    const out = document.getElementById("front-output");
    data.frontOutput = out ? out.value : "";

    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  function restoreFrontForm() {
    const key = getFrontKey();
    if (!key) return;

    let raw = null;
    try {
      raw = localStorage.getItem(key);
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
    if (!raw) {
      clearFrontFormExceptKey();
      return;
    }

    try {
      const data = JSON.parse(raw);

      // ã¾ãšå‹•çš„è¡Œã‚’å…¨éƒ¨å‰Šé™¤
      clearFrontDynamicSections();

      // ãƒ™ãƒ¼ã‚¹è¡Œ
      FRONT_FIELDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (data[id] !== undefined) {
          el.value = data[id];
        } else {
          el.value = "";
        }
      });

      // è¿½åŠ è¡Œã‚’å¾©å…ƒ
      if (Array.isArray(data.extraFrontResults)) {
        data.extraFrontResults.forEach(val => addFrontResult(val));
      }
      if (Array.isArray(data.extraFrontIssues)) {
        data.extraFrontIssues.forEach(val => addFrontIssue(val));
      }
      if (Array.isArray(data.extraFrontPlans)) {
        data.extraFrontPlans.forEach(val => addFrontPlan(val));
      }
      if (Array.isArray(data.extraFrontRefs)) {
        data.extraFrontRefs.forEach(val => addFrontRef(val));
      }

      if (data.frontOutput !== undefined) {
        const out = document.getElementById("front-output");
        if (out) out.value = data.frontOutput;
      }
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  // ==== ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ ä¿å­˜ãƒ»å¾©å…ƒ ====
  function getBackKey() {
    const date = v("back-date");
    const name = v("back-name");
    if (!date || !name) return null;
    return `nippo_back_${date}_${name}`;
  }

  function clearBackFormExceptKey() {
    BACK_FIELDS.forEach(id => {
      if (id === "back-date" || id === "back-name") return;
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    clearBackDynamicSections();
    const out = document.getElementById("back-output");
    if (out) out.value = "";
  }

  function saveBackForm() {
    const key = getBackKey();
    if (!key) return;

    const data = {};
    BACK_FIELDS.forEach(id => {
      const el = document.getElementById(id);
      if (el) data[id] = el.value;
    });

    data.extraBackWorks   = getExtraValues("back-work-input",   ["back-work1","back-work2","back-work3"]);
    data.extraBackResults = getExtraValues("back-result-input", ["back-result1","back-result2","back-result3"]);
    data.extraBackIssues  = getExtraValues("back-issue-input",  ["back-issue1","back-issue2","back-issue3"]);
    data.extraBackPlans   = getExtraValues("back-plan-input",   ["back-plan1","back-plan2","back-plan3"]);
    data.extraBackRefs    = getExtraValues("back-ref-input",    ["back-ref1","back-ref2","back-ref3"]);

    const out = document.getElementById("back-output");
    data.backOutput = out ? out.value : "";

    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  function restoreBackForm() {
    const key = getBackKey();
    if (!key) return;

    let raw = null;
    try {
      raw = localStorage.getItem(key);
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
    if (!raw) {
      clearBackFormExceptKey();
      return;
    }

    try {
      const data = JSON.parse(raw);

      clearBackDynamicSections();

      BACK_FIELDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (data[id] !== undefined) {
          el.value = data[id];
        } else {
          el.value = "";
        }
      });

      if (Array.isArray(data.extraBackWorks)) {
        data.extraBackWorks.forEach(val => addBackWork(val));
      }
      if (Array.isArray(data.extraBackResults)) {
        data.extraBackResults.forEach(val => addBackResult(val));
      }
      if (Array.isArray(data.extraBackIssues)) {
        data.extraBackIssues.forEach(val => addBackIssue(val));
      }
      if (Array.isArray(data.extraBackPlans)) {
        data.extraBackPlans.forEach(val => addBackPlan(val));
      }
      if (Array.isArray(data.extraBackRefs)) {
        data.extraBackRefs.forEach(val => addBackRef(val));
      }

      if (data.backOutput !== undefined) {
        const out = document.getElementById("back-output");
        if (out) out.value = data.backOutput;
      }
    } catch (e) {
      console.error("ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  }

  // ãƒ•ãƒ­ãƒ³ãƒˆç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼ˆMTGåº—èˆ—ãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤ï¼‰
  function buildFrontText() {
    const lines = [];

    lines.push("ã€æ—¥ä»˜ã€‘      ï¼š" + v("front-date"));
    lines.push("ã€æ°åã€‘      ï¼š" + v("front-name"));
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æœ¬æ—¥ã®æˆæœãƒ»é€²æ—(æ›´æ–°ãƒ»MTGè¨­å®šãªã©è‡ªåˆ†ãªã‚Šã®æˆæœ)");

    const resultBlock = buildBullets(
      ["front-result1","front-result2","front-result3"],
      "front-result-input"
    );
    lines.push(resultBlock);
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  èª²é¡Œãƒ»å•é¡Œç‚¹(å€‹äººã®èª²é¡Œãƒ»å•é¡Œç‚¹)");

    const issueBlock = buildBullets(
      ["front-issue1","front-issue2","front-issue3"],
      "front-issue-input"
    );
    lines.push(issueBlock);
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æ˜æ—¥ã®äºˆå®š(MTG/MTGå¤–ã®å‹•ã)");

    const planBlock = buildNumbered(
      ["front-plan1","front-plan2","front-plan3"],
      "front-plan-input"
    );
    lines.push(planBlock);
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æœ¬æ—¥ã®æ°—ã¥ããƒ»æŒ¯ã‚Šè¿”ã‚Šï¼ˆå­¦ã³ãƒ»æ”¹å–„ç‚¹ãªã©ï¼‰");

    const refBlock = buildBullets(
      ["front-ref1","front-ref2","front-ref3"],
      "front-ref-input"
    );
    lines.push(refBlock);

    return lines.join("\n");
  }

  // ãƒ•ãƒ­ãƒ³ãƒˆä»¥å¤–ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
  function buildBackText() {
    const lines = [];

    lines.push("ã€æ—¥ä»˜ã€‘      ï¼š" + v("back-date"));
    lines.push("ã€æ°åã€‘      ï¼š" + v("back-name"));
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æœ¬æ—¥ã®æ¥­å‹™å†…å®¹");

    const workBlock = buildNumbered(
      ["back-work1","back-work2","back-work3"],
      "back-work-input"
    );
    lines.push(workBlock);
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æœ¬æ—¥ã®æˆæœãƒ»é€²æ—");

    const resultBlock = buildBullets(
      ["back-result1","back-result2","back-result3"],
      "back-result-input"
    );
    lines.push(resultBlock);
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  èª²é¡Œãƒ»å•é¡Œç‚¹");

    const issueBlock = buildBullets(
      ["back-issue1","back-issue2","back-issue3"],
      "back-issue-input"
    );
    lines.push(issueBlock);
    lines.push("");
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æ˜æ—¥ã®äºˆå®š");

    const planBlock = buildNumbered(
      ["back-plan1","back-plan2","back-plan3"],
      "back-plan-input"
    );
    lines.push(planBlock);
    lines.push("â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•");
    lines.push("â–  æ°—ã¥ããƒ»æŒ¯ã‚Šè¿”ã‚Šï¼ˆå­¦ã³ãƒ»æ”¹å–„ç‚¹ãªã©ï¼‰");

    const refBlock = buildBullets(
      ["back-ref1","back-ref2","back-ref3"],
      "back-ref-input"
    );
    lines.push(refBlock);

    return lines.join("\n");
  }

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼å…±é€šå‡¦ç†
  function copyText(text, msgSpanId) {
    const msgSpan = document.getElementById(msgSpanId);

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => {
        msgSpan.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚";
        setTimeout(() => { msgSpan.textContent = ""; }, 2000);
      }).catch(err => {
        console.error(err);
        fallbackCopy(text, msgSpan);
      });
    } else {
      fallbackCopy(text, msgSpan);
    }
  }

  function fallbackCopy(text, msgSpan) {
    const temp = document.createElement("textarea");
    temp.value = text;
    document.body.appendChild(temp);
    temp.select();
    temp.setSelectionRange(0, temp.value.length);
    const ok = document.execCommand("copy");
    document.body.removeChild(temp);

    msgSpan.textContent = ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    setTimeout(() => { msgSpan.textContent = ""; }, 2000);
  }

  function generateAndCopyFront() {
    const text = buildFrontText();
    document.getElementById("front-output").value = text;
    saveFrontForm();   // ç”Ÿæˆæ™‚ã«ä¿å­˜
    copyText(text, "front-msg");
  }

  function generateAndCopyBack() {
    const text = buildBackText();
    document.getElementById("back-output").value = text;
    saveBackForm();    // ç”Ÿæˆæ™‚ã«ä¿å­˜
    copyText(text, "back-msg");
  }

  // â–¼ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸå‡¦ç†
  document.addEventListener("DOMContentLoaded", function() {
    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ YYYY/MM/DD å½¢å¼ã§ä½œæˆ
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm   = String(today.getMonth() + 1).padStart(2, "0");
    const dd   = String(today.getDate()).padStart(2, "0");
    const todayStr = `${yyyy}/${mm}/${dd}`;

    // æ—¥ä»˜æ¬„ãŒç©ºãªã‚‰ä»Šæ—¥ã®æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹
    ["front-date", "back-date"].forEach(id => {
      const el = document.getElementById(id);
      if (el && !el.value) {
        el.value = todayStr;
      }
    });

    // å‰å›ã®åå‰ã‚’ localStorage ã‹ã‚‰å–å¾—
    try {
      const savedName = localStorage.getItem("nippoName");
      if (savedName) {
        ["front-name", "back-name"].forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.value) {
            el.value = savedName;
          }
        });
      }
    } catch (e) {
      console.error("åå‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }

    // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ nippoName ã¨ã—ã¦ä¿å­˜
    ["front-name", "back-name"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", () => {
        const name = el.value.trim();
        if (!name) return;
        try {
          localStorage.setItem("nippoName", name);
        } catch (e) {
          console.error("åå‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        }
      });
    });

    // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜ï¼ˆâ€»æ—¥ä»˜ãƒ»åå‰ã¯é™¤ãï¼‰
    FRONT_SAVE_FIELDS.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", saveFrontForm);
    });
    BACK_SAVE_FIELDS.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", saveBackForm);
    });

    // æ—¥ä»˜ or åå‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€Œæ—¥ä»˜ï¼‹åå‰ã€ã§å¾©å…ƒã‚’è©¦ã¿ã‚‹
    ["front-date","front-name"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", restoreFrontForm);
    });
    ["back-date","back-name"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", restoreBackForm);
    });

    // åˆæœŸè¡¨ç¤ºæ™‚ã€ç¾åœ¨ã®ã€Œæ—¥ä»˜ï¼‹åå‰ã€ã§ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒ
    restoreFrontForm();
    restoreBackForm();

    // â˜… æœ€å¾Œã«é–‹ã„ã¦ã„ãŸã‚¿ãƒ–ã‚’å¾©å…ƒ
    try {
      const lastTab = localStorage.getItem("nippoLastTab");
      if (lastTab === "front" || lastTab === "back") {
        showForm(lastTab);
      }
    } catch (e) {
      console.error("ã‚¿ãƒ–çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ", e);
    }
  });
</script>

</body>
</html>
